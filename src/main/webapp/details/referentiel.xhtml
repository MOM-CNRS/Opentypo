<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <!-- Contenu dynamique -->
    <h:panelGroup class="image-container">
        <p:graphicImage
                value="#{not empty applicationBean.selectedReference.image and not empty applicationBean.selectedReference.image.url ? applicationBean.selectedReference.image.url : '/resources/img/o.png'}"
                styleClass="research-image"
                alt="Image du référentiel"
                onerror="this.src='/resources/img/o.png'; this.onerror=null;"/>
    </h:panelGroup>

    <h:panelGroup class="row">
        <div class="col-md-12">
            <div class="concept-info-panel">
                <!-- En-tête avec titre et actions -->
                <div class="concept-info-header">
                    <div class="concept-info-title-section">
                        <div class="concept-info-language-flag">
                            <h:graphicImage library="img" name="flag/fr.png"
                                            styleClass="language-flag"
                                            alt="Français"
                                            title="Français"/>
                        </div>
                        <h2 class="concept-info-title">#{applicationBean.selectedReference.nom}</h2>
                    </div>
                    <div class="concept-info-actions">
                        <p:commandLink action="#" process="@this" update="@none" styleClass="concept-action-button">
                            <i class="pi pi-cog" />
                            <p:tooltip value="Paramètres" position="top"/>
                        </p:commandLink>
                        <p:commandLink action="#" process="@this" update="@none" styleClass="concept-action-button">
                            <i class="pi pi-flag" />
                            <p:tooltip value="Marquer" position="top"/>
                        </p:commandLink>
                    </div>
                </div>

                <!-- Grille d'informations -->
                <div class="concept-info-grid">
                    <h:panelGroup class="concept-info-item">
                        <div class="concept-info-label">
                            <i class="pi pi-database concept-info-icon" />
                            <span>Code</span>
                        </div>
                        <div class="concept-info-value">#{applicationBean.selectedReference.code}</div>
                    </h:panelGroup>

                    <h:panelGroup class="concept-info-item concept-info-item-full">
                        <div class="concept-info-label">
                            <i class="pi pi-file concept-info-icon" />
                            <span>Description</span>
                        </div>
                        <div class="concept-info-value concept-info-description">
                            #{applicationBean.selectedReference.commentaire}
                        </div>
                    </h:panelGroup>

                    <h:panelGroup class="concept-info-item concept-info-item-full">
                        <div class="concept-info-label">
                            <i class="pi pi-user concept-info-icon" />
                            <span>Auteur(s)</span>
                        </div>
                        <div class="concept-info-value">
                            <ui:repeat value="#{applicationBean.selectedReference.auteurs}" var="auteur" varStatus="status">
                                #{auteur.prenom} #{auteur.nom}#{status.last ? '' : ', '}
                            </ui:repeat>
                        </div>
                    </h:panelGroup>

                    <h:panelGroup class="concept-info-item concept-info-item-full">
                        <div class="concept-info-label">
                            <i class="pi pi-book concept-info-icon" />
                            <span>Référence bibliographique</span>
                        </div>
                        <div class="concept-info-value">#{applicationBean.selectedReference.bibliographie}</div>
                    </h:panelGroup>
                </div>
            </div>

            <div class="row mt-20">
                <div class="col-md-12">
                    <div class="concept-info-panel">
                        <!-- En-tête avec titre et actions -->
                        <div class="concept-info-header">
                            <div class="concept-info-title-section">
                                <h2 class="concept-info-title fs-1rem">Catégories du référentiel - #{applicationBean.selectedReference.nom}</h2>
                            </div>
                            <div class="concept-info-actions">
                                <p:commandButton value="Créer une catégorie"
                                                 icon="pi pi-plus"
                                                 styleClass="category-create-button"
                                                 onclick="PF('createCategoryDialog').show(); return false;"
                                                 process="@this"
                                                 update="@none"/>
                            </div>
                        </div>

                        <!-- Grille d'informations -->
                        <div class="concept-info-grid">
                            <p:panel styleClass="panel-text-style">
                                <div class="referentiel-cards-container">
                                    <h:form>
                                        <div class="referentiel-cards-grid">
                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée. Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée. Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée. Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>

                                            <p:commandLink action="#{applicationBean.showCategory()}"
                                                           styleClass="referentiel-card"
                                                           process="@this"
                                                           update=":centerContent">
                                                <div class="referentiel-card-content">
                                                    <div class="referentiel-card-header">
                                                        <div class="referentiel-card-icon">
                                                            <i class="pi pi-tag" />
                                                        </div>
                                                        <div class="referentiel-card-title-wrapper">
                                                            <h3 class="referentiel-card-title">Titre CAT</h3>
                                                            <span class="referentiel-card-code">Code CAT</span>
                                                        </div>
                                                    </div>
                                                    <p class="referentiel-card-description">
                                                        Description courte du contenu, contexte scientifique,
                                                        résumé ou métadonnée.
                                                    </p>
                                                </div>
                                            </p:commandLink>
                                        </div>
                                    </h:form>
                                </div>
                            </p:panel>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </h:panelGroup>

    <!-- Dialog pour créer une nouvelle catégorie -->
    <p:dialog id="createCategoryDialog" 
              widgetVar="createCategoryDialog"
              header="Créer une nouvelle catégorie"
              modal="true"
              draggable="false"
              resizable="false"
              styleClass="category-dialog"
              width="600"
              height="auto"
              closable="true">
        
        <h:form id="categoryForm">
            <f:event listener="#{applicationBean.resetCategoryForm}" type="preRenderView"/>
            <div class="category-form-content">
                <div class="category-form-group">
                    <p:outputLabel for="categoryCode" value="Code de la catégorie *" />
                    <p:inputText id="categoryCode" 
                               value="#{applicationBean.categoryCode}"
                               required="true"
                               requiredMessage="Le code de la catégorie est requis"
                               styleClass="category-input"
                               placeholder="Ex: CAT001"/>
                </div>

                <div class="category-form-group">
                    <p:outputLabel for="categoryLabel" value="Label *" />
                    <p:inputText id="categoryLabel" 
                               value="#{applicationBean.categoryLabel}"
                               required="true"
                               requiredMessage="Le label est requis"
                               styleClass="category-input"
                               placeholder="Nom de la catégorie"/>
                </div>

                <div class="category-form-group">
                    <p:outputLabel for="categoryDescription" value="Description" />
                    <p:inputTextarea id="categoryDescription" 
                                    value="#{applicationBean.categoryDescription}"
                                    rows="4"
                                    styleClass="category-textarea"
                                    placeholder="Description de la catégorie"/>
                </div>
            </div>

            <div class="category-form-actions">
                <p:commandButton value="Annuler" 
                               icon="pi pi-times"
                               styleClass="category-btn category-btn-cancel"
                               onclick="PF('createCategoryDialog').hide(); return false;"
                               process="@this"
                               update="@none"/>
                <p:commandButton value="Valider" 
                               icon="pi pi-check"
                               styleClass="category-btn category-btn-validate"
                               action="#{applicationBean.createCategory}"
                               process="@form"
                               update="@form :growl"
                               oncomplete="if(!args.validationFailed) {PF('createCategoryDialog').hide();}"/>
            </div>
        </h:form>
    </p:dialog>

    <style>
        /* Bouton de création de catégorie */
        .category-create-button {
            background-color: var(--color-action-main, #47624D) !important;
            color: white !important;
            border: none !important;
            padding: 0.5rem 1rem !important;
            border-radius: 0.25rem !important;
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }

        .category-create-button:hover {
            background-color: #3a4f3f !important;
        }

        .category-create-button .ui-button-text {
            padding: 0 !important;
        }

        /* Styles pour le dialog de création de catégorie */
        .category-dialog .ui-dialog-content {
            padding: 1.5rem !important;
        }

        .category-form-content {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .category-form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .category-form-group label {
            font-weight: 500;
            color: var(--color-text-primary, #333);
            font-size: 0.9rem;
        }

        .category-input,
        .category-textarea {
            width: 100% !important;
            padding: 0.625rem 0.75rem !important;
            border: 1px solid rgba(71, 98, 77, 0.3) !important;
            border-radius: 0.25rem !important;
            font-size: 0.9rem !important;
            transition: all 0.2s ease !important;
        }

        .category-input:focus,
        .category-textarea:focus {
            border-color: var(--color-action-main, #47624D) !important;
            box-shadow: 0 0 0 3px rgba(71, 98, 77, 0.15) !important;
            outline: none !important;
        }

        .category-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .category-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(71, 98, 77, 0.15);
        }

        .category-btn {
            padding: 0.625rem 1.25rem !important;
            border-radius: 0.25rem !important;
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }

        .category-btn-cancel {
            background-color: var(--color-action-secondary, #6C757D) !important;
            color: white !important;
        }

        .category-btn-cancel:hover {
            background-color: #5a6268 !important;
        }

        .category-btn-validate {
            background-color: var(--color-action-main, #47624D) !important;
            color: white !important;
        }

        .category-btn-validate:hover {
            background-color: #3a4f3f !important;
        }

        /* Responsive pour le dialog */
        @media (max-width: 768px) {
            .category-dialog {
                width: 90% !important;
                max-width: 500px !important;
            }

            .category-form-actions {
                flex-direction: column-reverse;
            }

            .category-btn {
                width: 100%;
                justify-content: center;
            }

            .category-create-button {
                font-size: 0.75rem !important;
                padding: 0.4rem 0.75rem !important;
            }
        }
    </style>
</ui:composition>
