<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions">

    <!-- 1. Panneau détail collection : en-tête, vue/modifier, liste référentiels -->
    <h:panelGroup id="collectionDetailPanel" class="row collection-page-wrapper">
        <div class="col-md-12 collection-page-content">
            <h:form id="collectionEditForm" styleClass="groupe-header-form-inline">
                <div class="concept-info-panel #{entityEditModeBean.editingEntityInCatalog ? 'collection-edit-mode' : ''}">
                    <div class="concept-info-header #{entityEditModeBean.editingEntityInCatalog ? 'collection-edit-header' : ''}">
                        <div class="concept-info-title-section">
                            <span class="reference-entity-type-badge">Typologie</span>
                            <div class="concept-info-language-flag">
                                <h:graphicImage library="img" name="flag/fr.png"
                                                styleClass="language-flag"
                                                alt="Français"
                                                title="Français"/>
                            </div>
                            <div class="collection-panel-title-wrapper">
                                <h3 class="collection-panel-title">#{applicationBean.getEntityLabel(applicationBean.selectedEntity)}</h3>
                            </div>
                        </div>
                        <!-- Actions (masquées en mode édition) -->
                        <h:panelGroup class="concept-info-actions" rendered="#{loginBean.isAdminTechnique() and not entityEditModeBean.editingEntityInCatalog}">
                            <p:commandLink action="#{historyBean.loadHistory(applicationBean.selectedEntity)}"
                                           process="@this"
                                           update="@none"
                                           styleClass="concept-action-button"
                                           immediate="true">
                                <i class="pi pi-history" />
                                <p:tooltip value="Voir l'historique" position="top"/>
                            </p:commandLink>

                            <p:commandLink action="#{collectionBean.startEditingCollection(applicationBean)}"
                                           process="@this"
                                           update=":collectionEditForm"
                                           styleClass="concept-action-button"
                                           title="Modifier la collection"
                                           onstart="showLoading('Chargement...', 'spinner');"
                                           oncomplete="setTimeout(function(){hideLoading();}, 300);"
                                           onerror="forceHideLoading();">
                                <i class="pi pi-file-edit" />
                                <p:tooltip value="Modifier" position="top"/>
                            </p:commandLink>

                            <p:commandLink action="#{confirmDeleteBean.prepareDelete('COLLECTION')}"
                                           process="@this"
                                           update=":confirmDeleteDialogContent"
                                           oncomplete="PF('confirmDeleteDialog').show();"
                                           styleClass="concept-action-button"
                                           title="Supprimer la collection">
                                <i class="pi pi-trash" />
                                <p:tooltip value="Supprimer" position="top"/>
                            </p:commandLink>

                            <div class="collection-visibility-card">
                                <div class="collection-visibility-card-content">
                                    <div class="collection-visibility-indicator #{collectionBean.editingStatus ? 'collection-visibility-public' : 'collection-visibility-private'}">
                                        <div class="collection-visibility-icon">
                                            <i class="pi #{collectionBean.editingStatus ? 'pi-globe' : 'pi-lock'}" />
                                        </div>
                                        <div class="collection-visibility-info">
                                            <span class="collection-visibility-label">#{collectionBean.editingStatus ? 'Publique' : 'Privée'}</span>
                                        </div>
                                    </div>
                                    <div class="collection-visibility-toggle-wrapper">
                                        <p:commandLink styleClass="collection-visibility-toggle-btn"
                                                       process="@this"
                                                       update=":confirmVisibilityChangeDialog :confirmVisibilityChangeDialogContent"
                                                       action="#{collectionBean.prepareConfirmVisibilityChange(not collectionBean.editingStatus)}"
                                                       oncomplete="PF('confirmVisibilityChangeDialog').show();">
                                            <i class="pi pi-sync" />
                                            <p:tooltip value="Cliquez pour changer la visibilité" position="top"/>
                                        </p:commandLink>
                                    </div>
                                </div>
                            </div>
                        </h:panelGroup>

                        <h:panelGroup class="concept-info-actions"
                                      rendered="#{not loginBean.isAdminTechnique() and collectionBean.canEditCollectionAsGestionnaire(applicationBean.selectedEntity) and not entityEditModeBean.editingEntityInCatalog}">
                            <p:commandLink action="#{collectionBean.startEditingCollection(applicationBean)}"
                                           process="@this"
                                           update=":collectionEditForm"
                                           styleClass="concept-action-button"
                                           title="Modifier la collection"
                                           onstart="showLoading('Chargement...', 'spinner');"
                                           oncomplete="setTimeout(function(){hideLoading();}, 300);"
                                           onerror="forceHideLoading();">
                                <i class="pi pi-file-edit" />
                                <p:tooltip value="Modifier" position="top"/>
                            </p:commandLink>
                        </h:panelGroup>

                        <h:panelGroup class="concept-info-actions" rendered="#{!collectionBean.showCollectionStatut()}">
                            <h:panelGroup class="collection-visibility-card">
                                <div class="collection-visibility-card-content">
                                    <div class="collection-visibility-indicator #{collectionBean.editingStatus ? 'collection-visibility-public' : 'collection-visibility-private'}">
                                        <div class="collection-visibility-icon">
                                            <i class="pi #{collectionBean.editingStatus ? 'pi-globe' : 'pi-lock'}" />
                                        </div>
                                        <div class="collection-visibility-info">
                                            <span class="collection-visibility-label">#{collectionBean.editingStatus ? 'Publique' : 'Privée'}</span>
                                        </div>
                                    </div>
                                </div>
                            </h:panelGroup>
                        </h:panelGroup>
                    </div>

                    <!-- Vue lecture -->
                    <ui:fragment rendered="#{!entityEditModeBean.editingEntityInCatalog}">
                        <div class="concept-info-grid">
                            <h:panelGroup class="concept-info-item concept-info-item-full">
                                <div class="concept-info-label">
                                    <i class="pi pi-file concept-info-icon" />
                                    <span>Description</span>
                                </div>
                                <div class="concept-info-value concept-info-description">
                                    <ui:fragment rendered="#{not empty collectionBean.descriptionSelected and not empty collectionBean.descriptionSelected.valeur}">
                                        <h:outputText value="#{collectionBean.descriptionSelected.valeur}" escape="false"/>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{empty collectionBean.descriptionSelected or empty collectionBean.descriptionSelected.valeur}">
                                        <span class="empty-field-message">Non renseigné</span>
                                    </ui:fragment>
                                </div>
                            </h:panelGroup>

                            <div class="concept-info-item concept-info-item-full">
                                <div class="concept-info-label">
                                    <i class="pi pi-book concept-info-icon" />
                                    <span>Référence bibliographique</span>
                                </div>
                                <div class="concept-info-value bibliographie-container">
                                    <ui:fragment rendered="#{not empty applicationBean.selectedEntity.getRereferenceBibliographique()}">
                                        <ui:repeat value="#{fn:split(applicationBean.selectedEntity.getRereferenceBibliographique(), ';')}" var="ref" varStatus="status">
                                            <ui:fragment rendered="#{not empty ref and fn:trim(ref) != ''}">
                                                <span class="bibliographie-badge">
                                                    <span class="bibliographie-badge-text">#{fn:trim(ref)}</span>
                                                </span>
                                            </ui:fragment>
                                        </ui:repeat>
                                    </ui:fragment>
                                    <h:outputText value="Aucune référence bibliographique disponible"
                                                  rendered="#{empty applicationBean.selectedEntity.getRereferenceBibliographique()}"
                                                  styleClass="bibliographie-empty" />
                                </div>
                            </div>

                            <h:panelGroup class="concept-info-item concept-info-item-full">
                                <div class="concept-info-label">
                                    <i class="pi pi-users concept-info-icon" />
                                    <span>Gestionnaires de la collection</span>
                                </div>
                                <div class="concept-info-value bibliographie-container">
                                    <ui:fragment rendered="#{not empty collectionBean.getCollectionGestionnairesDisplayNames(applicationBean.selectedEntity)}">
                                        <ui:repeat value="#{collectionBean.getCollectionGestionnairesDisplayNames(applicationBean.selectedEntity)}" var="gestionnaire">
                                            <span class="bibliographie-badge">
                                                <span class="bibliographie-badge-text">#{gestionnaire}</span>
                                            </span>
                                        </ui:repeat>
                                    </ui:fragment>
                                    <h:outputText value="Aucun gestionnaire assigné"
                                                 rendered="#{empty collectionBean.getCollectionGestionnairesDisplayNames(applicationBean.selectedEntity)}"
                                                 styleClass="bibliographie-empty" />
                                </div>
                            </h:panelGroup>
                        </div>
                    </ui:fragment>

                    <!-- Mode édition : formulaire modifier -->
                    <ui:fragment rendered="#{entityEditModeBean.editingEntityInCatalog}">
                        <ui:include src="modifier.xhtml"/>
                    </ui:fragment>
                </div>
            </h:form>
        </div>
    </h:panelGroup>

    <!-- 2. Liste des référentiels (masquée en mode édition) -->
    <ui:fragment rendered="#{!entityEditModeBean.editingEntityInCatalog}">
        <h:form id="collectionReferencesForm">
            <p:remoteCommand name="openEditReferenceDialog"
                            action="#{referenceBean.prepareEditReferenceInDialogFromRequest()}"
                            process="@this"
                            update=":referenceDialog :referenceDialogForm"
                            oncomplete="PF('referenceDialog').show();"/>

            <p:remoteCommand name="openDeleteReferenceConfirm"
                            action="#{confirmDeleteBean.prepareDeleteReferenceFromRequest()}"
                            process="@this"
                            update=":confirmDeleteDialogContent"
                            oncomplete="PF('confirmDeleteDialog').show();"/>

            <div class="collection-references-header details-mt-20">
                <div class="collection-references-title-section">
                    <div class="collection-references-icon">
                        <i class="pi pi-database" />
                    </div>
                    <div class="collection-references-title-wrapper">
                        <h3 class="collection-references-title">Liste des référentiels</h3>
                        <span class="collection-references-subtitle">
                            #{applicationBean.getEntityLabel(applicationBean.selectedEntity)}
                        </span>
                    </div>
                </div>
                <h:panelGroup class="collection-references-actions" rendered="#{referenceBean.canCreateReference()}">
                    <p:commandButton value="Créer une nouvelle référence"
                                     icon="pi pi-plus"
                                     styleClass="collection-create-btn"
                                     action="#{referenceBean.prepareCreateReference}"
                                     process="@this"
                                     update=":referenceDialog :referenceDialogForm"
                                     oncomplete="PF('referenceDialog').show();"/>
                </h:panelGroup>
            </div>

            <ui:include src="liste_references.xhtml"/>
        </h:form>
    </ui:fragment>

    <h:outputStylesheet library="css" name="collection.css"/>
    <h:outputStylesheet library="css" name="candidats/opentheso-dialog.css"/>

    <h:outputScript library="js" name="treeUtils.js"/>

    <ui:include src="../references/referenceDialog.xhtml"/>
    <ui:include src="confirmVisibilityChangeDialog.xhtml"/>
</ui:composition>
