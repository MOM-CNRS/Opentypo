<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <h:form id="searchForm">
        <!-- Barre de recherche compacte et ergonomique - Une seule ligne -->
        <div class="search-bar-compact">
            <!-- Burger pour options (mobile) -->
            <div class="burger-search-control">
                <p:commandButton icon="pi pi-sliders-h"
                                 styleClass="search-burger-button p-button-rounded p-button-text"
                                 onclick="PF('searchOptionsPanel').show();"
                                 title="Options de recherche"
                                 process="@this" update="@none"/>
            </div>

            <!-- Collection - Compact sans label -->
            <p:selectOneMenu id="collectionSelect" 
                             value="#{searchBean.collectionSelected}"
                             styleClass="search-compact-select"
                             placeholder="Collection"
                             filter="true"
                             filterMatchMode="contains">
                <f:selectItems value="#{searchBean.hierarchicalCollectionItems}"/>
                <p:ajax event="change" listener="#{searchBean.onCollectionChange()}" 
                        update=":centerContent, :treeContainer" process="@this"
                        onstart="showLoading('Chargement...', 'spinner');"
                        oncomplete="setTimeout(function(){hideLoading(); ensureRootTogglerVisible();}, 500);"
                        onerror="forceHideLoading();"/>
            </p:selectOneMenu>

            <!-- Langue - Compact sans label -->
            <p:selectOneMenu id="langueSelect"
                             value="#{searchBean.langSelected}"
                             styleClass="search-compact-select"
                             title="#{langueBean.getMsg('search.change_thesaurus_language')}">
                <f:selectItems value="#{applicationBean.languages}" var="lang" 
                               itemLabel="#{lang.value}" itemValue="#{lang.code}"/>
                <p:ajax event="change" 
                        listener="#{applicationBean.onLanguageChange()}"
                        update=":centerContent" 
                        process="@this"/>
            </p:selectOneMenu>

            <!-- Zone de recherche principale - Compacte -->
            <div class="search-input-compact-wrapper">
                <p:inputText id="searchInput" 
                             value="#{searchBean.searchTerm}"
                             placeholder="Rechercher..." 
                             styleClass="search-input-compact"
                             autocomplete="off">
                    <p:ajax event="keypress" 
                            onkeypress="if(event.keyCode === 13) {PF('searchButton').click(); return false;}"/>
                </p:inputText>
                <p:commandButton id="searchButton"
                                 icon="pi pi-search"
                                 styleClass="search-button-compact"
                                 actionListener="#{searchBean.applySearch()}"
                                 process="@form" 
                                 update="@all"
                                 oncomplete="showResultsPanel();"
                                 title="Rechercher"/>
            </div>

            <!-- Bouton recherche avanc√©e - Compact -->
            <p:commandButton icon="pi pi-sliders-h"
                             styleClass="search-advanced-compact"
                             onclick="toggleAdvancedSearch(); return false;"
                             process="@this" 
                             update="@none"/>

            <!-- Bouton afficher/cacher les r√©sultats - Compact -->
            <p:commandButton id="toggleResultsPanelBtn"
                             icon="pi pi-chevron-right"
                             onclick="toggleRightPanel(); return false;"
                             styleClass="search-advanced-compact"
                             process="@this" 
                             update="@none"
                             title="Afficher / Cacher les r√©sultats"/>
        </div>

        <!-- Section recherche avanc√©e - Positionn√©e en dessous de la barre principale -->
        <div id="advanced-search-options" class="advanced-search-section-compact">
            <div class="advanced-filters-compact">
                <div class="filter-group-compact">
                    <p:outputLabel for="typeFilter" value="Type" styleClass="filter-label-compact"/>
                    <p:selectOneMenu id="typeFilter" styleClass="filter-select-compact">
                        <f:selectItem itemLabel="Tous" itemValue=""/>
                        <f:selectItem itemLabel="Collection" itemValue="collection"/>
                        <f:selectItem itemLabel="R√©f√©rence" itemValue="reference"/>
                        <f:selectItem itemLabel="Groupe" itemValue="groupe"/>
                        <f:selectItem itemLabel="S√©rie" itemValue="serie"/>
                        <f:selectItem itemLabel="Type" itemValue="type"/>
                    </p:selectOneMenu>
                </div>

                <div class="filter-group-compact">
                    <p:outputLabel for="statusFilter" value="Statut" styleClass="filter-label-compact"/>
                    <p:selectOneMenu id="statusFilter" 
                                     value="#{searchBean.searchSelected}" 
                                     styleClass="filter-select-compact">
                        <f:selectItem itemLabel="Tous" itemValue=""/>
                        <f:selectItem itemLabel="Actif" itemValue="active"/>
                        <f:selectItem itemLabel="Inactif" itemValue="inactive"/>
                    </p:selectOneMenu>
                </div>
            </div>
        </div>
    </h:form>


    <!-- Bouton toggle arbre, visible uniquement sur mobile, centr√© sous la barre -->
    <div class="tree-toggle-button" id="treeToggleButton">
        <p:commandButton icon="pi pi-sitemap"
                         styleClass="rounded-button ui-button-success"
                         onclick="toggleTreePanel(); return false;"
                         title="Afficher / Cacher l'arbre" />
    </div>

    <script>
        function toggleAdvancedSearch() {
            const section = document.getElementById('advanced-search-options');
            if (section) {
                section.classList.toggle('advanced-search-visible');
            }
        }

        /**
         * Met √† jour l'ic√¥ne du bouton selon l'√©tat du panel
         */
        function updateToggleButtonIcon() {
            const panel = document.getElementById('panelRight');
            const button = document.getElementById('toggleResultsPanelBtn');
            
            if (!panel || !button) return;
            
            const iconSpan = button.querySelector('.ui-button-icon-left, .ui-button-icon');
            if (!iconSpan) return;
            
            // V√©rifier si le panel est visible
            const isVisible = panel.classList.contains('visible');
            
            if (isVisible) {
                // Panel visible : ic√¥ne chevron-left (pour cacher)
                iconSpan.classList.remove('pi-chevron-right');
                iconSpan.classList.add('pi-chevron-left');
            } else {
                // Panel cach√© : ic√¥ne chevron-right (pour afficher)
                iconSpan.classList.remove('pi-chevron-left');
                iconSpan.classList.add('pi-chevron-right');
            }
        }

        function showResultsPanel() {
            const panel = document.getElementById('panelRight');
            
            if (!panel) return;
            
            // Afficher le panel
            panel.classList.add('visible');
            
            // Mettre √† jour l'ic√¥ne du bouton
            updateToggleButtonIcon();
        }

        function toggleRightPanel() {
            const panel = document.getElementById('panelRight');
            
            if (!panel) return;
            
            // Toggle la classe visible
            panel.classList.toggle('visible');
            
            // Mettre √† jour l'ic√¥ne du bouton selon l'√©tat
            updateToggleButtonIcon();
        }

        // Synchroniser l'ic√¥ne au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            updateToggleButtonIcon();
        });

        // Synchroniser l'ic√¥ne apr√®s le chargement complet (au cas o√π)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateToggleButtonIcon);
        } else {
            // Le DOM est d√©j√† charg√©
            setTimeout(updateToggleButtonIcon, 100);
        }

        // Fonction pour distinguer visuellement les collections et r√©f√©rences dans le menu
        function styleCollectionMenuItems() {
            const menuItems = document.querySelectorAll('.search-compact-select .ui-selectonemenu-items .ui-selectonemenu-item');
            menuItems.forEach(function(item) {
                const label = item.querySelector('.ui-selectonemenu-item-label');
                if (label) {
                    const text = label.textContent || label.innerText;
                    // Si c'est une collection (commence par üìÅ sans beaucoup d'espaces)
                    if (text.trim().startsWith('üìÅ')) {
                        item.classList.add('collection-menu-item');
                        item.classList.remove('reference-menu-item');
                    }
                    // Si c'est une r√©f√©rence (contient üìñ avec indentation)
                    else if (text.includes('üìñ')) {
                        var hasIndentation = text.startsWith(' ') || text.startsWith('\u00A0');
                        if (hasIndentation) {
                            item.classList.add('reference-menu-item');
                            item.classList.remove('collection-menu-item');
                        }
                    }
                }
            });
        }

        // Appliquer les styles apr√®s le chargement et apr√®s chaque ouverture du menu
        document.addEventListener('DOMContentLoaded', function() {
            styleCollectionMenuItems();
        });

        // Observer les changements dans le DOM pour r√©appliquer les styles
        if (typeof MutationObserver !== 'undefined') {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        setTimeout(styleCollectionMenuItems, 100);
                    }
                });
            });

            // Observer le conteneur du menu
            const menuContainer = document.querySelector('.search-compact-select');
            if (menuContainer) {
                observer.observe(menuContainer, { childList: true, subtree: true });
            }
        }

        // R√©appliquer les styles quand le menu s'ouvre
        // Utiliser addEventListener si jQuery n'est pas disponible
        document.addEventListener('click', function(e) {
            if (e.target) {
                var isTrigger = e.target.classList.contains('ui-selectonemenu-trigger') || 
                                e.target.closest('.ui-selectonemenu-trigger');
                if (isTrigger) {
                    const selectMenu = e.target.closest('.search-compact-select');
                    if (selectMenu) {
                        setTimeout(styleCollectionMenuItems, 200);
                    }
                }
            }
        });

        // Alternative avec jQuery si disponible
        if (typeof jQuery !== 'undefined') {
            jQuery(document).on('click', '.search-compact-select .ui-selectonemenu-trigger', function() {
                setTimeout(styleCollectionMenuItems, 200);
            });
        }
    </script>


    <!-- Permet de r√©initialiser l'affichage en mode bureau -->
    <script>
        function resetTreeOnResize() {
            const tree = document.getElementById('leftTreePanel');
            const iconSpan = document.querySelector('#treeToggleButton .ui-button-icon-left');

            if (!tree || !iconSpan) return;

            if (window.innerWidth >= 769) {
                // Mode bureau : on r√©initialise l'arbre
                tree.style.display = '';
                tree.style.position = '';
                tree.style.top = '';
                tree.style.left = '';
                tree.style.width = '';
                tree.style.height = '';
                tree.style.backgroundColor = '';
                tree.style.zIndex = '';
                tree.style.overflowY = '';

                // Ic√¥ne du bouton remise √† "ouvrir arbre"
                iconSpan.classList.remove('pi-times');
                iconSpan.classList.add('pi-sitemap');
            }
        }

        // Ex√©cute une premi√®re fois au chargement (au cas o√π)
        resetTreeOnResize();

        // Surveille les changements de taille de la fen√™tre
        window.addEventListener('resize', resetTreeOnResize);
    </script>

</ui:composition>
