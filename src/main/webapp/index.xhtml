<ui:composition template="commun/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="mainContent">

        <!-- 1. Barre de recherche -->
        <section class="app-search">
            <ui:include src="search/search.xhtml"/>
        </section>

        <!-- 2. Contenu principal (arbre + zone centrale + résultats recherche) -->
        <h:panelGroup id="centerContent" class="app-content">

            <!-- 2.1 Panneau arbre (gauche) -->
            <h:panelGroup id="leftTreePanel" class="left-tree" rendered="#{applicationBean.showTreePanel}">
                <ui:include src="tree/tree.xhtml"/>
            </h:panelGroup>

            <!-- 2.2 Zone centrale : présentation + cartes collections OU panneaux détail -->
            <h:panelGroup id="rightTreePanel" styleClass="center-content">
                <h:panelGroup id="cardsContainer" rendered="#{applicationBean.showCollectionsPanel}">
                    <ui:include src="index/sections/site-presentation.xhtml"/>
                    <ui:include src="index/sections/collections-panel.xhtml"/>
                </h:panelGroup>

                <!-- 2.3 Panneaux de détail (référentiel, catégorie, groupe, série, type) -->
                <div id="contentPanelsWrapper" class="content-panels-wrapper">
                    <h:panelGroup id="contentPanels" rendered="#{applicationBean.isShowDetail()}" layout="block" class="info-concept">
                        <ui:include src="details/breadCrumb.xhtml"/>

                        <h:panelGroup rendered="#{applicationBean.showReferencesPanel}">
                            <ui:include src="details/collections/collection.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.showReferencePanel}">
                            <ui:include src="details/references/reference.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.showCategoryPanel}">
                            <ui:include src="details/categories/category.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.isShowGroupePanel()}">
                            <ui:include src="details/groups/groupe.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.showSeriePanel}">
                            <ui:include src="details/series/serie.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.showTypePanel}">
                            <ui:include src="details/type/type.xhtml"/>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{applicationBean.selectedEntity.entityType.id != 6}">
                            <ui:include src="details/catalogues/liste_categories.xhtml"/>
                            <ui:include src="details/catalogues/liste_groupes.xhtml"/>
                            <ui:include src="details/catalogues/liste_series.xhtml"/>
                            <ui:include src="details/catalogues/liste_types.xhtml"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:panelGroup>

            <!-- 2.4 Formulaires cachés pour l'arbre (sélection, dépliage) -->
            <h:form id="treeSelectForm" styleClass="utility-hidden">
                <h:inputHidden id="treeEntityId" value="#{treeBean.selectedEntityIdForAjax}"/>
                <p:commandButton id="selectTreeEntityBtn"
                                styleClass="utility-hidden"
                                action="#{treeBean.selectEntityById}"
                                process="@this treeEntityId"
                                update=":contentPanels"
                                ajax="true"
                                onstart="if(typeof showPanelLoading === 'function') showPanelLoading('contentPanelsWrapper', 'Chargement...', 'spinner');"
                                oncomplete="setTimeout(function(){ if(typeof hidePanelLoading === 'function') hidePanelLoading(); if(typeof applyTreeSelectionHighlight === 'function') applyTreeSelectionHighlight(); }, 250);"
                                onerror="if(typeof hidePanelLoading === 'function') hidePanelLoading();"/>
            </h:form>
            <!-- Fragment pour injection des enfants (hors form pour résolution correcte par update) -->
            <h:panelGroup id="treeLoadChildrenFragment" layout="block" style="display:none !important; visibility:hidden;">
                <ui:include src="tree/treeChildrenFragment.xhtml"/>
            </h:panelGroup>
            <!-- Formulaire pour chargement des enfants au dépliage -->
            <h:form id="treeExpandForm" styleClass="utility-hidden">
                <h:inputHidden id="treeExpandEntityId" value="#{treeBean.expandEntityIdForAjax}"/>
                <p:commandButton id="loadTreeChildrenBtn"
                                styleClass="utility-hidden"
                                action="#{treeBean.loadChildrenForEntity}"
                                process="@this treeExpandEntityId"
                                update=":treeLoadChildrenFragment"
                                ajax="true"
                                onstart="if(typeof showPanelLoading === 'function') showPanelLoading('leftTreePanel', 'Chargement...', 'spinner');"
                                oncomplete="var inp=document.querySelector('[id$=treeExpandEntityId]'); var eid=inp?inp.value:null; if(typeof injectTreeChildrenFragment==='function'&amp;&amp;eid){injectTreeChildrenFragment(eid);} if(typeof hidePanelLoading==='function') hidePanelLoading(); if(typeof applyTreeSelectionHighlight==='function') applyTreeSelectionHighlight();"
                                onerror="if(typeof hidePanelLoading==='function') hidePanelLoading();"/>
            </h:form>

            <!-- Panneau droit pour les résultats de recherche -->
            <h:panelGroup id="panelRight" styleClass="search-result">
                <ui:include src="search/searchResult.xhtml"/>
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>
</ui:composition>
