<ui:composition template="commun/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="mainContent">

        <!-- 1. Barre de recherche -->
        <section class="app-search">
            <ui:include src="search/search.xhtml"/>
        </section>

        <!-- 2. Contenu principal (arbre + zone centrale + résultats recherche) -->
        <h:panelGroup id="centerContent" class="app-content">

            <!-- 2.1 Panneau arbre (gauche) -->
            <h:panelGroup id="leftTreePanel" class="left-tree" rendered="#{applicationBean.showTreePanel}">
                <ui:include src="tree/tree.xhtml"/>
            </h:panelGroup>

            <!-- 2.2 Zone centrale : présentation + cartes collections OU panneaux détail -->
            <h:panelGroup id="rightTreePanel" styleClass="center-content">
                <h:panelGroup id="cardsContainer" rendered="#{applicationBean.showCollectionsPanel}">
                    <ui:include src="index/sections/site-presentation.xhtml"/>
                    <ui:include src="index/sections/collections-panel.xhtml"/>
                </h:panelGroup>

                <!-- 2.3 Panneaux de détail (référentiel, catégorie, groupe, série, type) -->
                <div id="contentPanelsWrapper" class="content-panels-wrapper">
                    <h:panelGroup id="contentPanels" rendered="#{applicationBean.isShowDetail()}" layout="block" class="info-concept">
                        <ui:include src="details/breadCrumb.xhtml"/>
                        <h:panelGroup rendered="#{applicationBean.showReferencesPanel}">
                            <ui:include src="details/collections/collection.xhtml"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{applicationBean.showReferencePanel}">
                            <ui:include src="details/references/reference.xhtml"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{applicationBean.showCategoryPanel}">
                            <ui:include src="details/categories/category.xhtml"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{applicationBean.isShowGroupePanel()}">
                            <ui:include src="details/groups/groupe.xhtml"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{applicationBean.showSeriePanel}">
                            <ui:include src="details/serie.xhtml"/>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{applicationBean.showTypePanel}">
                            <ui:include src="details/type/type.xhtml"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:panelGroup>

            <!-- 2.4 Formulaires cachés pour l'arbre (sélection, dépliage) -->
            <h:form id="treeSelectForm" styleClass="utility-hidden">
                <h:inputHidden id="treeEntityId" value="#{treeBean.selectedEntityIdForAjax}"/>
                <p:commandButton id="selectTreeEntityBtn"
                                styleClass="utility-hidden"
                                action="#{treeBean.selectEntityById}"
                                process="@this treeEntityId"
                                update=":contentPanels, :breadcrumbContent"
                                ajax="true"
                                onstart="showPanelLoading('contentPanelsWrapper', 'Chargement...', 'spinner');"
                                oncomplete="setTimeout(function(){ hidePanelLoading(); if(typeof applyTreeSelectionHighlight === 'function'){ applyTreeSelectionHighlight(); } }, 250);"
                                onerror="hidePanelLoading();"/>
            </h:form>
            <!-- Formulaire pour chargement des enfants au dépliage : mise à jour uniquement du panel contenu et du panel arbre -->
            <h:form id="treeExpandForm" styleClass="utility-hidden">
                <h:inputHidden id="treeExpandEntityId" value="#{treeBean.expandEntityIdForAjax}"/>
                <p:commandButton id="loadTreeChildrenBtn"
                                styleClass="utility-hidden"
                                action="#{treeBean.loadChildrenForEntity}"
                                process="@this treeExpandEntityId"
                                update=":contentPanels, :leftTreePanel"
                                ajax="true"
                                onstart="if(typeof showLoading === 'function') showLoading('Chargement des éléments...', 'spinner');"
                                oncomplete="if(typeof hideLoading === 'function') hideLoading(); if(typeof applyTreeSelectionHighlight === 'function') applyTreeSelectionHighlight();"
                                onerror="if(typeof forceHideLoading === 'function') forceHideLoading();"/>
            </h:form>

            <!-- Panneau droit pour les résultats de recherche -->
            <h:panelGroup id="panelRight" styleClass="search-result">
                <ui:include src="search/searchResult.xhtml"/>
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>
</ui:composition>
