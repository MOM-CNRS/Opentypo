<ui:composition template="commun/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <ui:define name="mainContent">

        <!-- Barre de recherche -->
        <section class="app-search">
            <ui:include src="search/search.xhtml"/>
        </section>

        <!-- Contenu principal avec 3 panneaux -->
        <h:panelGroup id="centerContent" class="app-content">

            <!-- Tree -->
            <h:panelGroup id="leftTreePanel" class="left-tree" rendered="#{applicationBean.showTreePanel}">
                <ui:fragment>
                    <ui:include src="tree/tree.xhtml"/>
                </ui:fragment>
            </h:panelGroup>

            <h:panelGroup id="rightTreePanel" styleClass="center-content">
                <!-- Conteneur des cartes -->
                <h:panelGroup id="cardsContainer" rendered="#{applicationBean.showCollectionsPanel}">
                    <!-- Zone de présentation du site -->
                    <div class="site-presentation-container">
                        <div class="site-presentation-content">
                            <div class="site-presentation-header">
                                <div class="site-presentation-icon">
                                    <i class="pi pi-info-circle" />
                                </div>
                                <h2 class="site-presentation-title">À propos d'Opentypo</h2>
                            </div>
                            <div class="site-presentation-body">
                                <p class="site-presentation-text">
                                    Opentypo est une plateforme de recherche et de gestion de typologies archéologiques développée par le CNRS. 
                                    Cette application permet aux chercheurs de consulter, gérer et enrichir une base de données complète de types 
                                    archéologiques, facilitant ainsi la recherche scientifique et la documentation du patrimoine archéologique.
                                </p>
                                <div class="site-presentation-features">
                                    <div class="site-presentation-feature">
                                        <i class="pi pi-search site-presentation-feature-icon" />
                                        <div class="site-presentation-feature-content">
                                            <h4 class="site-presentation-feature-title">Recherche avancée</h4>
                                            <p class="site-presentation-feature-text">Explorez notre base de données avec des outils de recherche puissants et précis</p>
                                        </div>
                                    </div>
                                    <div class="site-presentation-feature">
                                        <i class="pi pi-database site-presentation-feature-icon" />
                                        <div class="site-presentation-feature-content">
                                            <h4 class="site-presentation-feature-title">Base de données complète</h4>
                                            <p class="site-presentation-feature-text">Accédez à une collection exhaustive de typologies archéologiques documentées</p>
                                        </div>
                                    </div>
                                    <div class="site-presentation-feature">
                                        <i class="pi pi-users site-presentation-feature-icon" />
                                        <div class="site-presentation-feature-content">
                                            <h4 class="site-presentation-feature-title">Collaboration</h4>
                                            <p class="site-presentation-feature-text">Participez à l'enrichissement de la base de données en proposant de nouveaux types</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section d'action pour créer une collection -->
                    <h:panelGroup id="create-collection-section" class="create-collection-section"
                         style="width: 100%; text-align: right; padding-top: 20px; padding-right: 20px"
                         rendered="#{loginBean.isAdmin()}">
                        <p:commandButton value="Créer une nouvelle collection"
                                         icon="pi pi-plus"
                                         styleClass="collection-btn collection-btn-validate"
                                         onclick="PF('addCollectionDialog').show(); return false;"
                                         process="@this"
                                         update="@none"/>
                    </h:panelGroup>

                    <div class="modern-cards-container">
                        <h:form id="collectionsForm">
                            <div class="modern-cards-grid">
                                <ui:repeat value="#{applicationBean.collections}" var="collection">
                                    <div class="modern-card-wrapper">
                                        <p:commandLink action="#{collectionBean.showCollectionDetail(applicationBean, collection)}"
                                                       styleClass="modern-card"
                                                       process="@this" ajax="true"
                                                       update=":centerContent :selectedEntityLabel :searchForm :breadcrumbContent :treeContainer :collectionSelect"
                                                       onstart="showLoading('Chargement de la collection...', 'spinner');"
                                                       oncomplete="setTimeout(function(){hideLoading(); ensureRootTogglerVisible();}, 500);"
                                                       onerror="forceHideLoading();">
                                            <div class="modern-card-content">
                                                <div class="modern-card-header">
                                                    <div class="modern-card-icon">
                                                        <i class="pi pi-folder" />
                                                    </div>
                                                    <h3 class="modern-card-title">#{applicationBean.getCollectionNameForLanguage(collection)}</h3>
                                                    <!-- Indicateur de statut privé/public -->
                                                    <h:panelGroup rendered="#{loginBean.canCreateOrEdit()}">
                                                        <div class="collection-card-status-badge #{collection.publique ? 'collection-status-public' : 'collection-status-private'}"
                                                             title="#{collection.publique ? 'Collection publique' : 'Collection privée'}">
                                                            <i class="pi #{collection.publique ? 'pi-globe' : 'pi-lock'}" />
                                                        </div>
                                                    </h:panelGroup>
                                                </div>
                                                <p class="modern-card-description">
                                                    #{empty applicationBean.getCollectionDescriptionForLanguage(collection) ? 'Aucune description disponible' : applicationBean.getCollectionDescriptionForLanguage(collection)}
                                                </p>
                                            </div>
                                        </p:commandLink>
                                    </div>
                                </ui:repeat>
                                
                                <!-- Message si aucune collection n'est disponible -->
                                <h:panelGroup class="empty-categories-message" rendered="#{empty applicationBean.collections}">
                                    <div class="empty-categories-icon">
                                        <i class="pi pi-inbox" />
                                    </div>
                                    <div class="empty-categories-content">
                                        <h4 class="empty-categories-title">Aucune collection disponible</h4>
                                        <h:panelGroup class="empty-categories-hint" rendered="#{loginBean.canCreateOrEdit()}">
                                            <i class="pi pi-info-circle" />
                                            <span>Il n'y a actuellement aucune collection dans la base de données.<br/>
                                                Utilisez le bouton "Créer une nouvelle collection" pour en ajouter une.</span>
                                        </h:panelGroup>
                                    </div>
                                </h:panelGroup>
                            </div>
                        </h:form>
                    </div>
                    
                    <!-- Inclusion du dialogue de création de collection -->
                    <ui:include src="dialogs/collectionDialog.xhtml"/>
                </h:panelGroup>

                <div id="contentPanelsWrapper" class="content-panels-wrapper">
                    <h:panelGroup id="contentPanels" rendered="#{applicationBean.isShowDetail()}" layout="block" class="info-concept">

                        <ui:include src="details/breadCrumb.xhtml"/>

                        <!-- Panneau référentiel -->
                        <h:panelGroup rendered="#{applicationBean.showReferencesPanel}">
                            <ui:include src="details/collections/collection.xhtml"/>
                        </h:panelGroup>

                        <!-- Panneau référentiel -->
                        <h:panelGroup rendered="#{applicationBean.showReferencePanel}">
                            <ui:include src="details/references/reference.xhtml"/>
                        </h:panelGroup>

                        <!-- Panneau catégorie -->
                        <h:panelGroup rendered="#{applicationBean.showCategoryPanel}">
                            <ui:include src="details/categories/category.xhtml"/>
                        </h:panelGroup>

                        <!-- Panneau groupe -->
                        <h:panelGroup rendered="#{applicationBean.isShowGroupePanel()}">
                            <ui:include src="details/groupe.xhtml"/>
                        </h:panelGroup>

                        <!-- Panneau série -->
                        <h:panelGroup rendered="#{applicationBean.showSeriePanel}">
                            <ui:include src="details/serie.xhtml"/>
                        </h:panelGroup>

                        <!-- Panneau série -->
                        <h:panelGroup rendered="#{applicationBean.showTypePanel}">
                            <ui:include src="details/type.xhtml"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:panelGroup>

            <!-- Formulaire pour sélection dans l'arbre : view state requis pour l'AJAX -->
            <h:form id="treeSelectForm" style="display:none;">
                <h:inputHidden id="treeEntityId" value="#{treeBean.selectedEntityIdForAjax}"/>
                <p:commandButton id="selectTreeEntityBtn"
                                style="display:none"
                                action="#{treeBean.selectEntityById}"
                                process="@this treeEntityId"
                                update=":contentPanels, :breadcrumbContent"
                                ajax="true"
                                onstart="showPanelLoading('contentPanelsWrapper', 'Chargement...', 'spinner');"
                                oncomplete="setTimeout(function(){ hidePanelLoading(); if(typeof applyTreeSelectionHighlight === 'function'){ applyTreeSelectionHighlight(); } }, 250);"
                                onerror="hidePanelLoading();"/>
            </h:form>
            <!-- Formulaire pour chargement des enfants au dépliage : mise à jour uniquement du panel contenu et du panel arbre -->
            <h:form id="treeExpandForm" style="display:none;">
                <h:inputHidden id="treeExpandEntityId" value="#{treeBean.expandEntityIdForAjax}"/>
                <p:commandButton id="loadTreeChildrenBtn"
                                style="display:none"
                                action="#{treeBean.loadChildrenForEntity}"
                                process="@this treeExpandEntityId"
                                update=":contentPanels, :leftTreePanel"
                                ajax="true"
                                onstart="if(typeof showLoading === 'function') showLoading('Chargement des éléments...', 'spinner');"
                                oncomplete="if(typeof hideLoading === 'function') hideLoading(); if(typeof applyTreeSelectionHighlight === 'function') applyTreeSelectionHighlight();"
                                onerror="if(typeof forceHideLoading === 'function') forceHideLoading();"/>
            </h:form>

            <!-- Panneau droit pour les résultats de recherche -->
            <h:panelGroup id="panelRight" styleClass="search-result">
                <ui:include src="search/searchResult.xhtml"/>
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>
</ui:composition>
